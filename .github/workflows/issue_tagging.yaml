name: Update parent issue

permissions: write-all

env:
  ISSUE_STATE: pr_inprogress
  REMOVE_ISSUES: --remove-label pr_approved --remove-label pr_review
  GH_TOKEN: ${{ github.token }}

on:
  issue_comment:
    types:
      - created #GitHub doesn't separate out PR comments from issue comments
  pull_request_target:
    types:
      - opened
      - edited
      - review_requested
jobs:
  update_parent_issue:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      - name: Get PR number on issue type
        id: issue_comment
        if: github.event_name == 'issue_comment' && github.event.issue.pull_request.url != ''
        run: echo "Fetching from PR comment" && echo "PR_NUM=${{ github.event.issue.number }}" >> "$GITHUB_ENV"

      - name: Get PR number on PR event
        id: pr_comment
        if: github.event_name == 'pull_request_target'
        run: echo "Fetching from PR state" && echo "PR_NUM=${{ github.event.number }}" >> "$GITHUB_ENV"

      - name: Get parent issues
        if: $PR_NUMBER != ''
        shell: bash
        run: >
          echo PARENT_ISSUE=$(
          .github/workflows/get_parent_issue.sh
          $PR_NUMBER
          ) >> $GITHUB_ENV

      - name: Fail when unable to find a parent issue
        if: $PR_NUMBER != ''
        run: echo "Could not find a parent issue" && exit 1

      - name: Get PR state
        if: $PR_NUMBER != ''
        run: >
          echo PR_STATUS=pr_$(
            gh pr view $PR_NUMBER --json reviewRequests,latestReviews | 
            python .github/workflows/determine_status.py
          )
    
      - name: Set parent issue state
        if: $PR_NUMBER != ''
        run: > 
          echo "Updating $PARENT_ISSUE to $ISSUE_STATE" &&
          gh issue edit $PARENT_ISSUE $REMOVE_ISSUES --add-label=$PR_STATE
        
